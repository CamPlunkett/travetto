import * as assert from 'assert';

import { Suite, Test, BeforeAll, AfterEach } from '@travetto/test';
import { ModelService, ModelRegistry } from '@travetto/model';
import { SchemaRegistry } from '@travetto/schema';
import { DependencyRegistry } from '@travetto/di';
import { Model<%= model.className %>Source } from '@travetto/model-<%= model.packageName %>';

import { Todo } from '../../src/model/todo';

// Import with side effects
import '../../src/model/config';

@Suite('Simple CRUD')
class TestCRUD {

  @BeforeAll()
  async before() {
    await SchemaRegistry.init();
    await DependencyRegistry.init();
    await ModelRegistry.init();
  }

  @AfterEach()
  async afterEach() {
    const mms = (await DependencyRegistry.getInstance(ModelSource)) as Model<%= model.className %>Source;
    return await mms.resetDatabase();
  }

  @Test('save it')
  async save() {
    const service = await DependencyRegistry.getInstance(ModelService);

    const saved = await service.save(Todo, Todo.from({
      title: 'A saved todo',
      completed: false
    }));

    assert(saved.id !== undefined);
  }
}